# Phase 2 Runbook: Earnings Attribution & Reconciliation

This document covers the earnings attribution and reconciliation features implemented in Phase 2.

## Overview

### Phase 2 Goals
- **Earnings Attribution**: Answer "how much did I earn?" for a wallet and time range
- **Reconciliation**: Detect drift between stored positions and live API data
- **Trust Pack Integration**: Surface reconciliation status in observability dashboard

---

## Earnings Attribution

### Core Identity

For each netuid and time period:
```
earnings_tao = end_value_tao - start_value_tao - net_flows_tao
```

**Definitions:**
- `start_value_tao`: Position value in TAO at start of period (from PositionSnapshot)
- `end_value_tao`: Position value in TAO at end of period (from PositionSnapshot)
- `net_flows_tao`: Net stake/unstake flows during period (positive = deposited, negative = withdrew)

### What Earnings Means

- **Earnings** represents the value generated by your staking positions above and beyond what you deposited
- It includes: validator rewards, emission yields, price appreciation of alpha tokens
- It does NOT include: unrealized gains from TAO price changes (all values are TAO-denominated)

### What Earnings Does NOT Mean

- **Not realized P&L**: Earnings are computed from position value changes, not actual trades
- **Not fee-adjusted**: Transaction fees are not subtracted from earnings
- **Not tax advice**: This is for informational purposes only

### Data Sources

1. **PositionSnapshot** table - Provides position values at timestamps
2. **DelegationEvent** table - Provides stake/unstake flows (primary source)
3. **StakeTransaction** table - Fallback if no delegation events exist

### Endpoints

#### GET /api/v1/earnings/summary

Returns earnings summary for a wallet over a time range.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `start` | ISO datetime | 30 days ago | Start of period |
| `end` | ISO datetime | now | End of period |
| `wallet` | string | WALLET_ADDRESS | Wallet to analyze |

**Response:**
```json
{
  "wallet_address": "5Gx...",
  "start": "2024-01-01T00:00:00Z",
  "end": "2024-01-31T00:00:00Z",
  "period_days": 30,
  "total_start_value_tao": "1000.0",
  "total_end_value_tao": "1050.0",
  "total_net_flows_tao": "100.0",
  "total_earnings_tao": "-50.0",
  "total_earnings_pct": "-5.0",
  "total_annualized_apy_estimate": "-60.83",
  "by_netuid": [
    {
      "netuid": 1,
      "start_value_tao": "500.0",
      "end_value_tao": "520.0",
      "net_flows_tao": "50.0",
      "earnings_tao": "-30.0",
      "earnings_pct": "-6.0",
      "annualized_apy_estimate": "-73.0"
    }
  ]
}
```

#### GET /api/v1/earnings/timeseries

Returns earnings timeseries for charting.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `start` | ISO datetime | 7 days ago | Start of period |
| `end` | ISO datetime | now | End of period |
| `granularity` | string | "day" | "hour" or "day" |
| `wallet` | string | WALLET_ADDRESS | Wallet to analyze |
| `include_by_netuid` | bool | false | Include per-netuid breakdown |

**Response:**
```json
{
  "wallet_address": "5Gx...",
  "start": "2024-01-01T00:00:00Z",
  "end": "2024-01-07T00:00:00Z",
  "granularity": "day",
  "bucket_count": 7,
  "buckets": [
    {
      "bucket_start": "2024-01-01T00:00:00Z",
      "bucket_end": "2024-01-02T00:00:00Z",
      "total_start_value_tao": "1000.0",
      "total_end_value_tao": "1005.0",
      "total_net_flows_tao": "0",
      "total_earnings_tao": "5.0",
      "total_earnings_pct": "0.5"
    }
  ]
}
```

---

## Reconciliation

### Purpose

Reconciliation compares stored position data vs live TaoStats API data to detect drift.
This helps identify:
- Sync failures that caused data to become stale
- API changes that affected data format
- Database corruption or data loss

### How It Works

1. Fetches all stored positions for the wallet from database
2. Calls TaoStats API to get current stake balances
3. Compares each position's TAO value and alpha balance
4. Uses tolerance thresholds to determine pass/fail
5. Records results in `reconciliation_runs` table
6. Updates Trust Pack with drift status

### Tolerances

| Tolerance | Default | Purpose |
|-----------|---------|---------|
| Absolute | 0.0001 TAO | For small values where relative % is misleading |
| Relative | 0.1% | For large values where absolute diff is expected |

A check **passes** if within **either** tolerance (OR logic).

### Endpoints

#### POST /api/v1/reconciliation/run

Triggers a new reconciliation run.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `wallet` | string | WALLET_ADDRESS | Wallet to reconcile |

**Response:**
```json
{
  "run_id": "recon_20240115_120000_a1b2c3d4",
  "created_at": "2024-01-15T12:00:00Z",
  "wallet_address": "5Gx...",
  "netuids_checked": [1, 2, 3],
  "passed": false,
  "total_checks": 3,
  "passed_checks": 2,
  "failed_checks": 1,
  "total_stored_value_tao": "1000.0",
  "total_live_value_tao": "1005.0",
  "total_diff_tao": "5.0",
  "total_diff_pct": "0.5",
  "checks": [
    {
      "netuid": 1,
      "passed": true,
      "stored_value_tao": "500.0",
      "live_value_tao": "500.0005",
      "value_diff_tao": "0.0005",
      "value_diff_pct": "0.0001",
      "within_absolute_tolerance": true,
      "within_relative_tolerance": true
    }
  ],
  "tolerances": {
    "absolute_tao": "0.0001",
    "relative_pct": "0.1"
  }
}
```

#### GET /api/v1/reconciliation/latest

Returns the most recent reconciliation run.

#### GET /api/v1/reconciliation/summary

Returns lightweight summary for dashboards.

**Response:**
```json
{
  "last_run_at": "2024-01-15T12:00:00Z",
  "last_run_passed": false,
  "failed_checks": 1,
  "total_diff_pct": "0.5",
  "has_drift": true
}
```

---

## Trust Pack Integration

Reconciliation status is included in the Trust Pack endpoint when `enable_reconciliation_in_trust_pack` is true.

**Location in Trust Pack:**
```json
{
  "reconciliation": {
    "last_run_at": "2024-01-15T12:00:00Z",
    "last_run_passed": false,
    "failed_checks": 1,
    "has_drift": true
  }
}
```

The `has_drift` flag is also set in the metrics collector's dataset status.

---

## Interpreting Failures

### Common Causes

1. **Sync lag**: Positions were recently synced but not yet reflected in snapshots
2. **API rate limiting**: Sync job was rate-limited and skipped updates
3. **New positions**: Positions opened after last sync aren't in DB yet
4. **Closed positions**: Positions unstaked but DB record not yet cleaned up

### What To Do

1. **Check sync status** in Trust Pack - is data stale?
2. **Trigger manual sync** via `POST /api/v1/tasks/sync`
3. **Re-run reconciliation** after sync completes
4. **Investigate large diffs** - may indicate real issues

### When To Investigate

- `has_drift: true` and `total_diff_pct > 1%`: Significant drift, investigate
- Multiple consecutive failed runs: Persistent issue, check sync jobs
- Individual netuid failures: May be normal during active trading

---

## Feature Flags

| Flag | Default | Purpose |
|------|---------|---------|
| `enable_earnings_endpoints` | true | Enable earnings API endpoints |
| `enable_reconciliation_endpoints` | true | Enable reconciliation API endpoints |
| `enable_reconciliation_in_trust_pack` | true | Include recon status in Trust Pack |
| `enable_earnings_timeseries_by_netuid` | false | Per-netuid breakdown in timeseries (heavy) |

### Tuning Tolerances

```bash
# Absolute tolerance (TAO)
export RECONCILIATION_ABSOLUTE_TOLERANCE_TAO=0.0001

# Relative tolerance (percentage)
export RECONCILIATION_RELATIVE_TOLERANCE_PCT=0.1
```

---

## Database Model

### reconciliation_runs

| Column | Type | Description |
|--------|------|-------------|
| id | bigint | Primary key |
| run_id | varchar(64) | Unique run identifier |
| created_at | timestamp | Run timestamp |
| wallet_address | varchar(128) | Wallet checked |
| netuids_checked | jsonb | Array of netuids |
| passed | boolean | Overall pass/fail |
| total_checks | int | Number of checks |
| passed_checks | int | Checks that passed |
| failed_checks | int | Checks that failed |
| total_stored_value_tao | numeric | Sum of stored values |
| total_live_value_tao | numeric | Sum of live values |
| total_diff_tao | numeric | Total value difference |
| total_diff_pct | numeric | Percentage difference |
| checks | jsonb | Detailed check results |
| error_message | text | Error if run failed |

---

## Known Limitations

1. **Snapshot frequency**: Earnings accuracy depends on position snapshots being recorded regularly
2. **Flow completeness**: Missing delegation events will affect earnings calculation
3. **No automated scheduling**: Reconciliation runs must be triggered manually (no scheduler)
4. **Single wallet**: Currently only supports the configured wallet address per run

### Future Improvements

- Automated daily reconciliation via scheduler
- Alert generation on drift detection
- Historical earnings rollup for arbitrary periods
- Multi-wallet support

---

## Files Added in Phase 2

| File | Type | Purpose |
|------|------|---------|
| `app/models/reconciliation.py` | NEW | ReconciliationRun model |
| `app/services/analysis/earnings.py` | NEW | Earnings attribution service |
| `app/services/analysis/reconciliation.py` | NEW | Reconciliation service |
| `app/api/v1/earnings.py` | NEW | Earnings endpoints |
| `app/api/v1/reconciliation.py` | NEW | Reconciliation endpoints |
| `tests/unit/test_phase2_earnings.py` | NEW | Earnings tests (14 tests) |
| `tests/unit/test_phase2_reconciliation.py` | NEW | Reconciliation tests (20 tests) |

### Files Modified

| File | Changes |
|------|---------|
| `app/core/config.py` | Added Phase 2 feature flags |
| `app/models/__init__.py` | Added ReconciliationRun export |
| `app/api/v1/__init__.py` | Added earnings and reconciliation routers |
| `app/api/v1/health.py` | Added reconciliation to Trust Pack |
